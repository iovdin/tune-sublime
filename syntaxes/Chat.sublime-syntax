%YAML 1.2
---
name: Chat
scope: text.chat
version: 2
file_extensions:
  - chat

variables:
  role_prefixes: '(?:s(?:ystem)?|u(?:ser)?|a(?:ssistant)?|tc|tool_call|tr|tool_result|c(?:omment)?|err(?:or)?)'

contexts:
  main:
    # Comment block: consume the label and enter comment context
    - match: '^(c(?:omment)?):'
      captures:
        1: keyword.constant.chat
      push: comment

    # system: (expandable) — add meta scope for system blocks
    - match: '^(s(?:ystem)?):'
      captures:
        1: keyword.constant.chat
      push: message-expandable-system

    # user: (expandable) — add meta scope for user blocks
    - match: '^(u(?:ser)?):'
      captures:
        1: keyword.declaration.chat
      push: message-expandable-user

    # tr: or tool_result: (expandable) — meta scope tool
    - match: '^(?:tr|tool_result):'
      scope: keyword.pseudo.chat
      push: message-expandable-tool

    # a: or assistant: (plain) — meta scope assistant
    - match: '^(a(?:ssistant)?):'
      captures:
        1: keyword.namespace.chat
      push: message-plain-assistant

    # tc: or tool_call: (plain) — meta scope tool
    - match: '^(?:tc|tool_call):'
      scope: keyword.reserved.chat
      push: message-plain-tool

    # err: or error: (plain, mark as invalid) — meta scope error
    - match: '^(err(?:or)?):'
      captures:
        1: invalid.illegal.chat
      push: message-plain-error

    # Handle the Rouge edge-case: bare leading colon treated like pseudo + expandable
    - match: '^:'
      scope: keyword.pseudo.chat
      push: message-expandable-tool

    # Fallback plain text
    - match: '.+'
      scope: text.plain

  # Content with variable expansion support
  message-expandable:
    # New role starts a new block
    - match: '^(?={{role_prefixes}}:)'
      set: main

    # @var or @@var; @{...} or @@{...}
    - match: '(?<![\\@])@(?:\{[^}]+\}|\S+)'
      scope: variable.function

    # Plain text chunks that don't include '@' (so we don't swallow following variables)
    - match: "[^@\\\n]+"
      scope: text.plain

    # Fallback single character (including stray '@')
    - match: '.'
      scope: text.plain

  # Content without expansion support
  message-plain:
    - match: '^(?={{role_prefixes}}:)'
      set: main
    - match: '.+'
      scope: text.plain

  # Role-specific wrappers to provide meta scopes (for color scheme block styling)
  message-expandable-user:
    - meta_scope: meta.role.user.chat
    - include: message-expandable

  message-expandable-system:
    - meta_scope: meta.role.system.chat
    - include: message-expandable

  message-expandable-tool:
    - meta_scope: meta.role.tool.chat
    - include: message-expandable

  message-plain-assistant:
    - meta_scope: meta.role.assistant.chat
    - include: message-plain

  message-plain-tool:
    - meta_scope: meta.role.tool.chat
    - include: message-plain

  message-plain-error:
    - meta_scope: meta.role.error.chat
    - include: message-plain

  # Comment context: label is highlighted, body is comment; supports expansions and escapes
  # and exits when a new role starts.
  comment:
    - meta_scope: meta.role.comment.chat
    - match: '^(?={{role_prefixes}}:)'
      set: main

    - match: '^(c(?:omment)?):'
      captures:
        1: keyword.constant.chat

    # @var or @@var; @{...} or @@{...}
    - match: '(?<!\\)@{1,2}(?:\{[^}]+\}|\S+)'
      scope: variable.function

    - match: '.+'
      scope: comment.line.chat
